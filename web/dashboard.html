<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Dashboard</title>
        <link href="dashboardStyle.css" rel="stylesheet" type="text/css" />
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    </head>
    <body>

        <div class="row">
            <div class='column column35'>
                <h1>Enter In Start and End Date In Form of dd-MM-YYYY To View History</h1>
                <!--search bars-->
                <div>
                    <h4 id="inputCheck"></h4>
                    <input id=startDate  placeholder="Search Start Date..">
                    <input id=endDate  placeholder="Search End Date..">
                    <button onClick="getInfo()">submit</button>
                </div> 
                <!--unique users-->
                <div class='attribute'>
                    <h3>NUMBER OF UNIQUE USERS</h3>
                    <h4 id="users"></h4>
                </div>     
                <!--browsers-->
                <div>
                    <h3>TOP BROWSERS</h3>
                    <ol id="browsers">
                    </ol>
                </div> 
                <!--urls-->
                <div>
                    <h3>TOP URLS</h3>
                    <ol id="urls">
                    </ol>
                </div>
                <!--requests-->
                <div>
                    <h3>REQUESTS PER TIME INTERVAL</h3>
                    <ul id="requests">
                    </ul>
                </div>
            </div>
        </div>
        <!--chart-->
        <div class="row">
            <div class='column column65'> 
                <canvas id="myChart" width="400" height="400"></canvas>
            </div>
        </div>

        <script>
            function getInfo() {
                var obj = {};
                //getting elements from html page
                obj.users = document.getElementById('users');
                obj.browsers = document.getElementById('browsers');
                obj.urls = document.getElementById('urls');
                obj.requests = document.getElementById('requests');
                obj.chart = document.getElementById('myChart').getContext("2d");
                obj.startDate = document.getElementById('startDate').value;
                obj.endDate = document.getElementById('endDate').value;

                //clearing out elements so the page is empty
                obj.users.innerHTML = "";
                obj.browsers.innerHTML = "";
                obj.urls.innerHTML = "";
                obj.requests.innerHTML = "";

                //getting start and end dates to add to fetch url
                obj.startDate = obj.startDate.split(' ').join('');
                obj.endDate = obj.endDate.split(' ').join('');
                var inputCheck = document.getElementById('inputCheck');
                inputCheck.innerHTML = "";

                //getting url
                let url = 'http://localhost:8081/views?startDate=' + obj.startDate + '&endDate=' + obj.endDate;

                //function to handle errors
                function handleErrors(response) {
                    if (!response.ok) {
                        inputCheck.innerHTML = "Error dates entered are invalid";
                    }
                    return response;
                }
                //fetching url and getting data
                fetch(url)
                        .then(handleErrors)
                        .then(response => response.json())
                        .then(viewsInfo => {
                            console.log(viewsInfo);
                            console.log(viewsInfo.uniqueUsers);
                            console.log(viewsInfo.browsers);
                            console.log(viewsInfo.URLs);
                            console.log(viewsInfo.requests);
                            //getting number of unique users
                            obj.users.innerHTML = viewsInfo.uniqueUsers;
                            //getting browsers list
                            obj.browsers.innerHTML = "";
                            var browserList = viewsInfo.browsers;
                            for (var i = 0; i < browserList.length; i++) {
                                var listEle = document.createElement("li");
                                listEle.innerHTML = browserList[i];
                                obj.browsers.appendChild(listEle);
                            }
                            //getting urls list
                            obj.urls.innerHTML = "";
                            var urlList = viewsInfo.URLs;
                            for (var i = 0; i < urlList.length; i++) {
                                var listEle = document.createElement("li");
                                listEle.innerHTML = urlList[i];
                                obj.urls.appendChild(listEle);
                            }
                            //getting requests list
                            obj.requests.innerHTML = "";
                            var requestList = viewsInfo.requests;
                            var x = [];
                            var y = [];
                            for (var i = 0; i < requestList.length; i++) {
                                var listEle = document.createElement("li");
                                listEle.innerHTML = "Start Time: " + requestList[i].time + " Number of requests: " + requestList[i].requests;
                                obj.requests.appendChild(listEle);
                                x.push(requestList[i].time);
                                y.push(requestList[i].requests);
                            }
                            //creating chart
                            console.log("time " + x);
                            console.log("number of requests " + y);
                            BuildChart(x, y, "Number of Requests over Time");
                            function BuildChart(labels, values, chartTitle) {
                                obj.chart = document.getElementById("myChart").getContext('2d');
                                obj.chart.canvas.parentNode.style.height = '128px';
                                let chart = new Chart(obj.chart, {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                                label: chartTitle,
                                                display: 'false',
                                                borderColor: "red",
                                                pointBackgroundColor: "red",
                                                data: values,
                                                fill: false
                                            }]
                                    },
                                    options: {
                                        title: {
                                            display: true,
                                            text: 'Number of Requests Over Time'
                                        },
                                        scales: {
                                            yAxes: [{
                                                    ticks: {
                                                        beginAtZero: true
                                                    },
                                                    scaleLabel: {
                                                        display: true,
                                                        labelString: "Number of Requests",
                                                        fontColor: "black"
                                                    }
                                                }],
                                            xAxes: [{
                                                    scaleLabel: {
                                                        display: true,
                                                        labelString: "Time",
                                                        fontColor: "black"
                                                    }
                                                }]
                                        }
                                    }

                                });
                            }
                            ;
                        });
                return obj;
            }
            ;
        </script>
    </body>
</html>
